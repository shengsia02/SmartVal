{% extends "core/base_public.html" %}
{% load static humanize %}

{% block title %}ä¼°åƒ¹çµæœ - SmartVal{% endblock %}

{% block extra_css %}
{# 1. Leaflet åŸºç¤æ¨£å¼ #}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

{# 2. MarkerCluster (èœ˜è››ç¶²/èšåˆ) æ¨£å¼ - åªå¼•å…¥çµæ§‹æª”ï¼Œä¸å¼•å…¥ Default Theme #}
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />

<style>
    /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
    .custom-table th { background-color: #0ea5e9; color: white; }
    .custom-table tr:nth-child(even) { background-color: #f8fafc; }
    .custom-table tr:hover { background-color: #f0f9ff; }

    /* === 1. ç›®æ¨™æˆ¿å±‹ï¼šé›·é”æ³¢ç´‹æ•ˆæœ (å« Icon) === */
    .radar-core {
        width: 32px;
        height: 32px;
        background-color: #ef4444; /* red-500 */
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white; 
    }
    .radar-pulse {
        width: 60px;
        height: 60px;
        background-color: rgba(239, 68, 68, 0.4);
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: pulse-animation 2s infinite;
        z-index: 1;
    }
    @keyframes pulse-animation {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
    }

    /* === 2. å‘¨é‚Šæˆ¿å±‹ï¼šè³ªæ„Ÿæ°´æ»´æ¨™è¨˜ (SVG) === */
    .nearby-pin-icon {
        background: transparent;
        border: none;
    }
    .nearby-pin-svg {
        filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.3));
        transition: transform 0.2s;
    }
    .nearby-pin-icon:hover .nearby-pin-svg {
        transform: scale(1.1) translateY(-5px);
    }

    /* === 3. Tooltip è³‡è¨Šå¡ç‰‡æ¨£å¼ === */
    .custom-tooltip {
        background: white;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        padding: 0;
        overflow: hidden;
    }
    .leaflet-tooltip-left:before, .leaflet-tooltip-right:before {
        border: none !important;
    }

    /* === [é—œéµä¿®æ”¹] 4. è‡ªå®šç¾© MarkerCluster (å¼·åˆ¶è—è‰²èšåˆæ¨£å¼) === */
    /* ä½¿ç”¨ !important å¼·åˆ¶è¦†è“‹æ‰€æœ‰å¯èƒ½æ®˜ç•™çš„é¡è‰²è¨­ç½® */
    
    /* å¤–åœˆ (åŠé€æ˜è—è‰²) */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large, 
    .marker-cluster, .custom-cluster-blue {
        background-color: rgba(37, 99, 235, 0.4) !important; /* Blue-600 40% */
        border-radius: 50%;
    }

    /* å…§åœˆ (å¯¦å¿ƒè—è‰²) */
    .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div,
    .marker-cluster div, .custom-cluster-blue div {
        background-color: #2563eb !important; /* Blue-600 */
        color: white !important;
        width: 30px;
        height: 30px;
        margin-left: 5px;
        margin-top: 5px;
        text-align: center;
        border-radius: 50%;
        font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
        line-height: 30px;
        font-weight: bold;
        text-shadow: none !important;
    }

    /* ç¢ºä¿æ•¸å­—ç½®ä¸­ */
    .marker-cluster span, .custom-cluster-blue span {
        line-height: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-slate-50 min-h-screen py-10">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
        
        {# === å€å¡Š 1: ä¼°åƒ¹çµæœæ‘˜è¦ === #}
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="border-b border-gray-100 p-6 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="text-blue-600">ğŸ </span> æ‚¨çš„æˆ¿å±‹åƒ¹æ ¼é æ¸¬çµæœ
                    </h2>
                    <p class="text-slate-500 mt-1 text-sm">
                        ä¼°åƒ¹æ¨™çš„ï¼š<span class="font-medium text-slate-700">{{ input_data.city }}{{ input_data.town }}{{ input_data.street }}</span>
                    </p>
                </div>
                
                {% if user.is_authenticated %}
                    {% if is_snapshot %}
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-slate-400 font-medium hidden sm:inline-block">
                                æ”¶è—æ–¼ {{ record.created_at|date:"Y/m/d" }}
                            </span>
                            <form action="{% url 'core:remove_favorite' record.id %}" method="post" onsubmit="return confirm('ç¢ºå®šè¦ç§»é™¤é€™ç­†æ”¶è—å—ï¼Ÿ');">
                                {% csrf_token %}
                                <button type="submit" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-500 rounded-lg hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition shadow-sm group">
                                    <svg class="w-5 h-5 transition group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    <span class="font-bold">ç§»é™¤æ”¶è—</span>
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <div id="favorite-action-container">
                            <button onclick="addToFavorite()" class="flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-300 hover:border-pink-300 hover:bg-pink-50 text-slate-600 hover:text-pink-600 rounded-lg transition shadow-sm group">
                                <svg class="w-5 h-5 transition group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                                <span class="font-medium">åŠ å…¥æ”¶è—</span>
                            </button>
                        </div>
                    {% endif %}
                {% else %}
                    <a href="{% url 'account_login' %}?next={{ request.path }}" class="text-sm text-blue-600 hover:underline">ç™»å…¥ä»¥æ”¶è—çµæœ</a>
                {% endif %}
            </div>

            <div class="p-6 md:p-8">
                <div class="flex flex-col lg:flex-row gap-8">
                    {# å·¦å´ï¼šåƒ¹æ ¼å¤§å¡ç‰‡ #}
                    <div class="w-full lg:w-1/3 space-y-4">
                        <div class="relative bg-white rounded-2xl p-6 shadow-lg border border-blue-100 overflow-hidden group hover:shadow-xl transition-shadow duration-300">
                            <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full opacity-50 transition group-hover:scale-110"></div>
                            <div class="relative z-10">
                                <div class="flex items-center gap-2 mb-2 text-slate-500">
                                    <div class="p-1.5 bg-blue-100 text-blue-600 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    <span class="font-bold text-sm tracking-wider uppercase">é ä¼°ç¸½åƒ¹</span>
                                </div>
                                <div class="flex items-baseline gap-1 mt-1">
                                    <span class="text-5xl font-extrabold text-blue-600 tracking-tight">{{ result.price|floatformat:0 }}</span>
                                    <span class="text-xl font-bold text-slate-400">è¬</span>
                                </div>
                                <p class="text-xs text-slate-400 mt-3 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    AI æ™ºæ…§ä¼°ç®—åƒè€ƒå€¼
                                </p>
                            </div>
                        </div>

                        <div class="relative bg-slate-50 rounded-2xl p-5 border border-slate-200 flex items-center justify-between">
                            <div>
                                <div class="flex items-center gap-2 text-slate-500 mb-1">
                                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
                                    <span class="font-bold text-xs tracking-wider uppercase">é ä¼°å–®åƒ¹</span>
                                </div>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-2xl font-bold text-slate-700">{{ unit_price|floatformat:1 }}</span>
                                    <span class="text-sm font-medium text-slate-500">è¬ / åª</span>
                                </div>
                            </div>
                            <div class="text-slate-200">
                                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            </div>
                        </div>
                    </div>

                    {# å³å´ï¼šè©³ç´°è³‡æ–™ === #}
                    <div class="w-full lg:w-2/3">
                        <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 h-full flex flex-col justify-between">
                            <div>
                                <h3 class="text-sm font-bold text-slate-400 mb-6 uppercase tracking-wider flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                    è¼¸å…¥æ¢ä»¶ç¢ºèª
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-8 text-sm">
                                    <div class="md:col-span-2 bg-white p-3 rounded-lg border border-slate-200">
                                        <span class="block text-xs font-bold text-slate-400 mb-1">é–€ç‰Œåœ°å€</span>
                                        <span class="block font-bold text-slate-800 text-lg break-words leading-relaxed">
                                            {{ input_data.city }}{{ input_data.town }}{{ input_data.street }}
                                        </span>
                                    </div>
                                    <div class="border-b border-slate-200 pb-2">
                                        <span class="block text-xs font-bold text-slate-400 mb-1">æˆ¿å±‹é¡å‹</span>
                                        <span class="block font-bold text-slate-700 text-base">{{ input_data.house_type }}</span>
                                    </div>
                                    <div class="border-b border-slate-200 pb-2">
                                        <span class="block text-xs font-bold text-slate-400 mb-1">å±‹é½¡</span>
                                        <span class="block font-bold text-slate-700 text-base">{{ input_data.house_age }} å¹´</span>
                                    </div>
                                    <div class="border-b border-slate-200 pb-2">
                                        <span class="block text-xs font-bold text-slate-400 mb-1">ç¸½æ¨“å±¤ / æ‰€åœ¨æ¨“å±¤</span>
                                        <span class="block font-bold text-slate-700 text-base">{{ input_data.total_floors|floatformat:0 }} æ¨“ / {{ input_data.floor_number|floatformat:0 }} æ¨“</span>
                                    </div>
                                    <div class="border-b border-slate-200 pb-2">
                                        <span class="block text-xs font-bold text-slate-400 mb-1">å»ºåª (å«å…¬è¨­)</span>
                                        <span class="block font-bold text-slate-700 text-base">{{ input_data.floor_area }} åª</span>
                                    </div>
                                    <div class="border-b border-slate-200 pb-2">
                                        <span class="block text-xs font-bold text-slate-400 mb-1">åœ°åª</span>
                                        <span class="block font-bold text-slate-700 text-base">{{ input_data.land_area }} åª</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-6 border-t border-slate-200 flex gap-3">
                                <a href="{% url 'core:home' %}" class="px-5 py-2.5 bg-white border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 transition text-sm font-bold flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    é‡æ–°è©¦ç®—
                                </a>
                                <button class="flex-1 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200 text-sm font-bold flex justify-center items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 3.666A5.002 5.002 0 0115 17H9a5.002 5.002 0 01-3-4.75V11a2 2 0 012-2h3"></path></svg>
                                    é¡åº¦åˆ©ç‡è©•ä¼°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# === å€å¡Š 2: é„°è¿‘è¨­æ–½è³‡è¨Š (åœ°åœ–) === #}
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 p-1.5 rounded-md">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </span>
                    <h3 class="text-lg font-bold text-slate-800">å‘¨é‚Šå¯¦åƒ¹ç™»éŒ„ä½ç½®</h3>
                </div>
                <div class="text-xs bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    é¡¯ç¤º 10 ç­†æœ€è¿‘ä¸”æ¢ä»¶ç›¸ä¼¼ä¹‹ç‰©ä»¶
                </div>
            </div>
            
            <div id="map" class="w-full z-0" style="height: 600px;"></div>
        </div>

        {# === å€å¡Š 3: å‘¨é‚Šå¯¦åƒ¹è³‡è¨Š (è¡¨æ ¼) === #}
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-blue-50 border-b border-blue-100 p-4">
                <div class="flex gap-3">
                    <div class="flex-shrink-0 mt-0.5">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-blue-800 mb-1">AI æ™ºæ…§ç¯©é¸é‚è¼¯èªªæ˜</h4>
                        <p class="text-xs text-blue-600 leading-relaxed">
                            ç³»çµ±ä¾æ“šæ‚¨çš„è¼¸å…¥æ¢ä»¶ï¼Œè‡ªå‹•å¾è³‡æ–™åº«ä¸­ç¯©é¸å‡ºæœ€ç›¸ä¼¼çš„æˆäº¤æ¡ˆä¾‹ã€‚ç¯©é¸æ¨™æº–åŒ…å«ï¼š
                            <span class="font-bold">åŒè¡Œæ”¿å€ã€åŒæˆ¿å±‹é¡å‹</span>ï¼Œä¸”æ»¿è¶³
                            <span class="font-bold">å±‹é½¡ Â±5 å¹´</span>ã€
                            <span class="font-bold">æ¨“å±¤ Â±5 å±¤</span>ã€
                            <span class="font-bold">åªæ•¸ Â±10 åª</span> ä¹‹æ¢ä»¶ã€‚
                            æœ€å¾Œä¾è·é›¢æ’åºï¼Œå–æœ€è¿‘çš„ 10 ç­†è³‡æ–™ä¾›æ‚¨åƒè€ƒã€‚
                        </p>
                    </div>
                </div>
            </div>

            <div class="p-4 border-b border-gray-100 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-700 p-1.5 rounded-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                </span>
                <h3 class="text-lg font-bold text-slate-800">å‘¨é‚Šå¯¦åƒ¹ç™»éŒ„åˆ—è¡¨</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse custom-table">
                    <thead>
                        <tr class="text-sm">
                            <th class="py-3 px-4 font-semibold rounded-tl-lg">åœ°å€</th>
                            <th class="py-3 px-4 font-semibold">é¡å‹</th>
                            <th class="py-3 px-4 font-semibold text-center">å±‹é½¡</th>
                            <th class="py-3 px-4 font-semibold text-right">å»ºåª</th>
                            <th class="py-3 px-4 font-semibold text-right">ç¸½åƒ¹(è¬)</th>
                            <th class="py-3 px-4 font-semibold text-center rounded-tr-lg">è·é›¢</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm text-slate-700">
                        {% for house in result.nearby_houses %}
                        <tr class="transition">
                            <td class="py-3 px-4 font-medium">{{ house.address }}</td>
                            <td class="py-3 px-4 text-slate-500">{{ house.type }}</td>
                            <td class="py-3 px-4 text-center">{{ house.age }} å¹´</td>
                            <td class="py-3 px-4 text-right font-mono">{{ house.area }}</td>
                            <td class="py-3 px-4 text-right font-bold text-blue-600">{{ house.price }}</td>
                            <td class="py-3 px-4 text-center text-slate-400">{{ house.distance_km }} km</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="py-8 text-center text-slate-400 bg-slate-50">
                                æŸ¥ç„¡å‘¨é‚Šå¯¦åƒ¹ç™»éŒ„è³‡æ–™
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    const BTN_ADD_HTML = `
        <button onclick="addToFavorite()" class="flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-300 hover:border-pink-300 hover:bg-pink-50 text-slate-600 hover:text-pink-600 rounded-lg transition shadow-sm group">
            <svg class="w-5 h-5 transition group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
            <span class="font-medium">åŠ å…¥æ”¶è—</span>
        </button>
    `;

    function getRemoveBtnHtml(recordId) {
        return `
            <div class="flex items-center gap-3">
                <span class="text-sm text-pink-600 font-bold animate-pulse">âœ… å·²åŠ å…¥æ”¶è—</span>
                <button onclick="removeFavoriteDynamic(${recordId})" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-500 rounded-lg hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition shadow-sm group">
                    <svg class="w-5 h-5 transition group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span class="font-bold">ç§»é™¤æ”¶è—</span>
                </button>
            </div>
        `;
    }

    function addToFavorite() {
        const container = document.getElementById('favorite-action-container');
        container.innerHTML = '<span class="text-slate-400 text-sm">è™•ç†ä¸­...</span>';

        fetch("{% url 'core:add_favorite' %}", {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                container.innerHTML = getRemoveBtnHtml(data.id);
            } else {
                alert("åŠ å…¥å¤±æ•—ï¼š" + data.msg);
                container.innerHTML = BTN_ADD_HTML;
            }
        })
        .catch(err => {
            console.error(err);
            alert("ç³»çµ±éŒ¯èª¤");
            container.innerHTML = BTN_ADD_HTML;
        });
    }

    function removeFavoriteDynamic(recordId) {
        if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ”¶è—å—ï¼Ÿ')) return;
        const container = document.getElementById('favorite-action-container');
        container.innerHTML = '<button class="px-5 py-2.5 bg-gray-100 text-gray-400 rounded-lg flex items-center gap-2"><span class="animate-spin">â³</span> è™•ç†ä¸­...</button>';

        fetch(`/favorites/remove/${recordId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if(data.success) {
                container.innerHTML = BTN_ADD_HTML;
            } else {
                alert("ç§»é™¤å¤±æ•—ï¼š" + data.msg);
                container.innerHTML = getRemoveBtnHtml(recordId);
            }
        })
        .catch(err => {
            console.error(err);
            alert("ç³»çµ±éŒ¯èª¤");
        });
    }

    // === åœ°åœ–åˆå§‹åŒ–èˆ‡ Marker Cluster ===
    document.addEventListener('DOMContentLoaded', function() {
        const target = {{ result.target_coords|default:"{}"|safe }};
        const nearby = {{ result.nearby_houses|default:"[]"|safe }};
        const price = "{{ result.price }}"; 

        // 1. åˆå§‹åŒ–åœ°åœ–
        var map = L.map('map');
        
        if (target && target.lat && target.lng) {
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            var boundsPoints = [];

            // === A. ç›®æ¨™æˆ¿å±‹ ===
            const targetIcon = L.divIcon({
                className: '',
                html: `
                    <div class="radar-core">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 3L4 9V21H9V14H15V21H20V9L12 3Z" fill="white"/>
                        </svg>
                    </div>
                    <div class="radar-pulse"></div>
                `,
                iconSize: [0, 0]
            });
            
            L.marker([target.lat, target.lng], {icon: targetIcon, zIndexOffset: 1000}).addTo(map);
            boundsPoints.push([target.lat, target.lng]);

            // === B. å‘¨é‚Šæˆ¿å±‹ ===
            // [é—œéµä¿®æ”¹]ï¼šé€™è£¡é›–ç„¶å·²ç¶“è‡ªå®šç¾© classï¼Œä½†ä¸Šé¢ CSS æœƒå¼·åˆ¶ç”¨ !important è¦†å¯«
            var markers = L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                spiderfyOnMaxZoom: true,
                
                // 1. èœ˜è››ç¶²å±•é–‹æ™‚çš„ç·šæ¢é¡è‰² (Blue)
                spiderLegPolylineOptions: { weight: 1.5, color: '#2563eb', opacity: 0.5 },
                
                // 2. èšåˆå€åŸŸçš„å¤šé‚Šå½¢é‚Šç•Œé¡è‰² (Blue)
                polygonOptions: { color: '#2563eb', weight: 3, opacity: 0.5, fillOpacity: 0.2 },
                
                // 3. Icon æ¨£å¼
                iconCreateFunction: function(cluster) {
                    var childCount = cluster.getChildCount();
                    // Class name åŒ…å« custom-cluster-blueï¼Œä¸Šé¢çš„ CSS æœƒæŠ“åˆ°
                    return new L.DivIcon({ 
                        html: '<div><span>' + childCount + '</span></div>', 
                        className: 'marker-cluster custom-cluster-blue', 
                        iconSize: new L.Point(40, 40) 
                    });
                }
            });

            // è—è‰²æ°´æ»´ Icon
            const pinSvg = `
            <svg class="nearby-pin-svg" width="36" height="36" viewBox="0 0 384 512" xmlns="http://www.w3.org/2000/svg">
                <path fill="#2563eb" d="M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0z"/>
                <path fill="white" transform="translate(96, 128) scale(0.375)" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v96a16 16 0 0 0 16 16L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l232.16-191.24a15.25 15.25 0 0 1 19.4 0l232.16 191.24a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.61-16.93z"/>
            </svg>`;

            nearby.forEach(function(house) {
                if(house.lat && house.lng) {
                    const customIcon = L.divIcon({
                        className: 'nearby-pin-icon',
                        html: pinSvg,
                        iconSize: [36, 36],
                        iconAnchor: [18, 36]
                    });

                    const marker = L.marker([house.lat, house.lng], { icon: customIcon });

                    const tooltipContent = `
                        <div class="p-3 min-w-[250px]">
                            <h4 class="font-bold text-slate-800 text-sm mb-2 border-b border-gray-100 pb-2 truncate">${house.address}</h4>
                            <div class="flex flex-col gap-1 text-xs text-slate-600">
                                <div class="flex justify-between">
                                    <span>é¡å‹ï¼š${house.type}</span>
                                    <span>å»ºåªï¼š${house.area}åª</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å±‹é½¡ï¼š${house.age}å¹´</span>
                                    <span>å–®åƒ¹ï¼š${(house.price / house.area).toFixed(1)}è¬/åª</span>
                                </div>
                            </div>
                            <div class="mt-3 text-right">
                                <span class="text-xs text-slate-400 mr-1">æˆäº¤ç¸½åƒ¹</span>
                                <span class="text-red-600 font-bold text-lg">$${house.price}è¬</span>
                            </div>
                        </div>
                    `;

                    marker.bindTooltip(tooltipContent, {
                        direction: 'top',
                        offset: [0, -36],
                        className: 'custom-tooltip',
                        opacity: 1
                    });

                    markers.addLayer(marker);
                    boundsPoints.push([house.lat, house.lng]);
                }
            });

            map.addLayer(markers);

            // === è‡ªå‹•ç¸®æ”¾é‚è¼¯ ===
            if (boundsPoints.length > 0) {
                if (boundsPoints.length === 1) {
                    map.setView(boundsPoints[0], 18);
                } else {
                    var bounds = L.latLngBounds(boundsPoints);
                    map.fitBounds(bounds, {
                        padding: [50, 50],
                        maxZoom: 18
                    });
                }
            } else {
                map.setView([25.0330, 121.5654], 13);
            }

        } else {
            document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full text-slate-400 bg-slate-100">ç„¡åœ°åœ–è³‡æ–™</div>';
        }
    });
</script>
{% endblock %}