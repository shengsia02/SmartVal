{% extends "core/base_public.html" %}
{% load static widget_tweaks i18n %}

{% block title %}SmartVal æ™ºèƒ½æˆ¿å±‹ä¼°åƒ¹ç³»çµ±{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* 1. å®šç¾©ç”±ä¸‹å¾€ä¸Šæµ®ç¾çš„å‹•ç•«é—œéµå½±æ ¼ */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px); /* åˆå§‹ä½ç½®å‘ä¸‹åç§» 30px */
        }
        to {
            opacity: 1;
            transform: translateY(0); /* æœ€çµ‚ä½ç½®æ­¸é›¶ */
        }
    }

    /* 2. æ‡‰ç”¨å‹•ç•«çš„é¡åˆ¥ */
    .animate-enter {
        opacity: 0; /* é è¨­éš±è—ï¼Œé¿å…å‹•ç•«é–‹å§‹å‰é–ƒçˆ */
        animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; /* ä½¿ç”¨æµæš¢çš„ç·©å‹•å‡½æ•¸ */
    }

    /* 3. è¨­å®šä¸åŒçš„å»¶é²æ™‚é–“ï¼Œå‰µé€ ã€Œæ¼¸é€²ã€æ•ˆæœ */
    .delay-100 { animation-delay: 0.1s; }
    .delay-200 { animation-delay: 0.2s; }
    .delay-300 { animation-delay: 0.3s; }
    .delay-400 { animation-delay: 0.4s; }
    .delay-500 { animation-delay: 0.5s; }
</style>

{% endblock %}

{% block content %}

{# === å€å¡Š 1ï¼šHero Section (èƒŒæ™¯åœ– + è¡¨å–®) === #}
<section class="relative w-full min-h-[calc(100vh-64px)] flex items-center justify-center bg-cover bg-center bg-no-repeat py-8"
         style="background-image: url('{% static 'core/images/background_ntpu.jpg' %}');">
    
    {# é»‘è‰²é®ç½© (è®“æ–‡å­—æ›´æ¸…æ™°ï¼Œå¯é¸) #}
    <div class="relative z-10 w-full max-w-3xl px-4">
        
        <div class="relative bg-white/85 backdrop-blur-md shadow-2xl rounded-2xl p-4 sm:p-6 compact-mode-padding overflow-hidden border border-white/40 animate-enter">
            
            <form method="post" class="space-y-4 compact-mode-space" id="estimation-form" novalidate>
                {% csrf_token %}
                
                <div class="space-y-5">
                    <div class="flex justify-between items-center pb-3 border-b border-gray-200 animate-enter delay-100">
                        <h2 class="text-xl font-bold text-slate-800">æˆ¿å±‹è³‡è¨Š</h2>
                        <span class="text-xs font-medium text-red-600 bg-red-50 px-2 py-1 rounded">* æ¬„ä½çš†å¿…å¡«</span>
                    </div>
                    
                    {# 1. åœ°å€æ¬„ä½çµ„ #}
                    <div class="space-y-1 animate-enter delay-200"> 
                        <label class="block text-sm font-bold text-gray-700">åœ°å€</label>
                        <div class="grid grid-cols-12 gap-2">
                            <div class="col-span-12 sm:col-span-3">{{ form.city|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition compact-input" }}</div>
                            <div class="col-span-12 sm:col-span-3">{{ form.town|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition compact-input" }}</div>
                            <div class="col-span-12 sm:col-span-6">{{ form.street|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition compact-input" }}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-3 gap-y-2 sm:gap-x-4 sm:gap-y-3 animate-enter delay-300">
                        {# 2-8 æ¬„ä½ (ä¿æŒä¸è®Š) #}
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">æˆ¿å±‹é¡å‹</label>
                            {{ form.house_type|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition compact-input" }}
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">å±‹é½¡</label>
                            <div class="relative">
                                {{ form.house_age|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-8 transition compact-input" }}
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-medium">å¹´</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">ç¸½æ¨“å±¤</label>
                            <div class="relative">
                                {{ form.total_floors|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-8 transition compact-input" }}
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-medium">æ¨“</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">æ‰€åœ¨æ¨“å±¤</label>
                            <div class="relative">
                                {{ form.floor_number|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-8 transition compact-input" }}
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-medium">æ¨“</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">å»ºåª</label>
                            <div class="relative">
                                {{ form.floor_area|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-8 transition compact-input" }}
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-medium">åª</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">åœ°åª</label>
                            <div class="relative">
                                {{ form.land_area|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-8 transition compact-input" }}
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-medium">åª</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">æˆ¿é–“æ•¸</label>
                            <div class="relative">
                                {{ form.room_count|add_class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-8 transition compact-input" }}
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-medium">é–“</span>
                            </div>
                        </div>
                    </div>
                </div>

                {# æŒ‰éˆ•å€åŸŸ #}
                <div class="pt-2 flex justify-center gap-3 animate-enter delay-400">
                    <button type="submit" class="w-full sm:w-auto px-8 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-0.5 text-sm sm:text-base">
                        é–‹å§‹ä¼°åƒ¹
                    </button>
                    <button type="reset" class="w-full sm:w-auto px-8 py-2.5 bg-white hover:bg-gray-50 border border-gray-200 text-gray-700 font-bold rounded-lg shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 text-sm sm:text-base">
                        æ¸…é™¤é‡å¡«
                    </button>
                </div>
            </form>

            {# æœªç™»å…¥é®ç½© (ä¿æŒä¸è®Š) #}

            {% if not user.is_authenticated %}
            <div class="absolute inset-0 z-50 bg-slate-200/60 backdrop-blur-md flex flex-col items-center justify-center text-center rounded-2xl">
                <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm mx-4 transform transition-all scale-100 border border-gray-100">
                    <div class="mb-4 text-blue-600 flex justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">æœƒå“¡å°ˆå±¬åŠŸèƒ½</h3>
                    <p class="text-slate-500 mb-6">
                        ç‚ºäº†æä¾›ç²¾ç¢ºçš„ä¼°åƒ¹æœå‹™ä¸¦ä¿å­˜æ‚¨çš„æŸ¥è©¢ç´€éŒ„ï¼Œ<br>è«‹å…ˆç™»å…¥å¾Œä½¿ç”¨æœ¬åŠŸèƒ½ã€‚
                    </p>
                    
                    {# æŒ‰éˆ•ï¼šé»æ“Šå¾Œå‰å¾€ç™»å…¥é ï¼Œä¸¦è¨­å®š next åƒæ•¸ï¼Œç™»å…¥å¾Œè‡ªå‹•è·³å›é¦–é  #}
                    <a href="{% url 'account_login' %}?next={% url 'core:home' %}" 
                    class="inline-block w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition transform hover:-translate-y-0.5">
                        ç«‹å³ç™»å…¥ / è¨»å†Š
                    </a>
                    
                    <p class="mt-4 text-sm text-slate-400">
                        é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="{% url 'account_signup' %}?next={% url 'core:home' %}" class="text-blue-600 hover:underline">å…è²»è¨»å†Š</a>
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</section>

{# === æ–°å¢å€å¡Š 2ï¼šæ ¸å¿ƒå„ªå‹¢ (Features) === #}
<section class="py-16 bg-white">
    <div class="container mx-auto px-4 max-w-6xl">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-slate-800 mb-4">ç‚ºä»€éº¼é¸æ“‡ SmartValï¼Ÿ</h2>
            <p class="text-slate-600 max-w-2xl mx-auto">
                æˆ‘å€‘çµåˆäº†æœ€æ–°çš„ AI æ¼”ç®—æ³•èˆ‡å¯¦åƒ¹ç™»éŒ„å¤§æ•¸æ“šï¼Œç‚ºæ‚¨æä¾›æœ€å®¢è§€ã€å³æ™‚çš„æˆ¿ç”¢åƒ¹å€¼åˆ†æã€‚
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {# Feature 1 #}
            <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 hover:shadow-lg transition text-center group">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">AI å¤§æ•¸æ“šåˆ†æ</h3>
                <p class="text-slate-600 text-sm leading-relaxed">
                    æ•´åˆå…§æ”¿éƒ¨å¯¦åƒ¹ç™»éŒ„è³‡æ–™ï¼Œé‹ç”¨æ©Ÿå™¨å­¸ç¿’æ¨¡å‹ï¼Œç²¾æº–è€ƒé‡åœ°æ®µã€å±‹é½¡ã€æ¨“å±¤ç­‰å¤šé‡å› å­ã€‚
                </p>
            </div>

            {# Feature 2 #}
            <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 hover:shadow-lg transition text-center group">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">å³æ™‚å¿«é€Ÿä¼°åƒ¹</h3>
                <p class="text-slate-600 text-sm leading-relaxed">
                    ç„¡éœ€æ¼«é•·ç­‰å¾…æˆ–äººå·¥å¯©æ ¸ï¼Œåªè¦è¼¸å…¥æˆ¿å±‹åŸºæœ¬è³‡è¨Šï¼Œç³»çµ±å³åˆ»ç‚ºæ‚¨è¨ˆç®—å‡ºåƒè€ƒåƒ¹æ ¼ã€‚
                </p>
            </div>

            {# Feature 3 #}
            <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 hover:shadow-lg transition text-center group">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">é€æ˜å®¢è§€æ•¸æ“š</h3>
                <p class="text-slate-600 text-sm leading-relaxed">
                    æ¶ˆé™¤è³‡è¨Šä¸å°ç¨±ï¼Œæä¾›å‘¨é‚Šç›¸ä¼¼ç‰©ä»¶çš„æˆäº¤è¡Œæƒ…å°æ¯”ï¼Œè®“æ‚¨å°å¸‚å ´åƒ¹æ ¼ç­å¦‚æŒ‡æŒã€‚
                </p>
            </div>
        </div>
    </div>
</section>

{# === æ–°å¢å€å¡Š 3ï¼šä½¿ç”¨æƒ…å¢ƒ (Use Cases) === #}
<section class="py-16 bg-slate-50">
    <div class="container mx-auto px-4 max-w-6xl">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-slate-800 mb-4">æŒæ¡æˆ¿åƒ¹ï¼Œç„¡è«–æ‚¨çš„è§’è‰²æ˜¯...</h2>
            <div class="w-20 h-1 bg-blue-600 mx-auto rounded"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {# Case 1: è²·æ–¹ #}
            <div class="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition">
                <div class="h-2 bg-green-500"></div>
                <div class="p-8">
                    <div class="text-green-600 font-bold tracking-wide text-sm mb-2 uppercase">For Buyers</div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-4">æ­£åœ¨å°‹æ‰¾å¤¢æƒ³å®¶åœ’</h3>
                    <p class="text-slate-600 mb-6">
                        æ“”å¿ƒè²·è²´äº†å—ï¼Ÿé€é SmartVal æŸ¥è©¢åˆç†åƒ¹æ ¼å€é–“ï¼Œè®“æ‚¨åœ¨è­°åƒ¹æ™‚æ›´æœ‰åº•æ°£ï¼Œæ¯ä¸€åˆ†éŒ¢éƒ½èŠ±å¾—å€¼å¾—ã€‚
                    </p>
                    <ul class="space-y-2 text-sm text-slate-500">
                        <li class="flex items-center"><span class="text-green-500 mr-2">âœ“</span> é¿å…é«˜æ–¼å¸‚å ´è¡Œæƒ…çš„é–‹åƒ¹</li>
                        <li class="flex items-center"><span class="text-green-500 mr-2">âœ“</span> äº†è§£ä¸åŒå€åŸŸçš„åƒ¹æ ¼å·®ç•°</li>
                    </ul>
                </div>
            </div>

            {# Case 2: è³£æ–¹ #}
            <div class="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition">
                <div class="h-2 bg-blue-600"></div>
                <div class="p-8">
                    <div class="text-blue-600 font-bold tracking-wide text-sm mb-2 uppercase">For Sellers</div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-4">è¨ˆåŠƒå‡ºå”®ç¾æœ‰æˆ¿ç”¢</h3>
                    <p class="text-slate-600 mb-6">
                        ä¸çŸ¥é“è©²é–‹åƒ¹å¤šå°‘ï¼Ÿé€éå¤§æ•¸æ“šåˆ†æï¼Œè¨‚å®šæœ€å…·ç«¶çˆ­åŠ›çš„åƒ¹æ ¼ï¼Œç¸®çŸ­éŠ·å”®é€±æœŸï¼ŒåŒæ™‚ä¿éšœæ‚¨çš„è³‡ç”¢åƒ¹å€¼ã€‚
                    </p>
                    <ul class="space-y-2 text-sm text-slate-500">
                        <li class="flex items-center"><span class="text-blue-600 mr-2">âœ“</span> è¨­å®šåˆç†çš„éŠ·å”®é–‹åƒ¹</li>
                        <li class="flex items-center"><span class="text-blue-600 mr-2">âœ“</span> æŒæ¡è¿‘æœŸå‘¨é‚Šæˆäº¤å‹•æ…‹</li>
                    </ul>
                </div>
            </div>

            {# Case 3: æŠ•è³‡å®¢/å±‹ä¸» #}
            <div class="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition">
                <div class="h-2 bg-purple-500"></div>
                <div class="p-8">
                    <div class="text-purple-500 font-bold tracking-wide text-sm mb-2 uppercase">For Owners</div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-4">è³‡ç”¢ç®¡ç†èˆ‡è¿½è¹¤</h3>
                    <p class="text-slate-600 mb-6">
                        å®šæœŸè¿½è¹¤åä¸‹æˆ¿ç”¢åƒ¹å€¼æ³¢å‹•ã€‚ç„¡è«–æ˜¯ç‚ºäº†å¢è²¸è©•ä¼°é‚„æ˜¯é•·æœŸæŠ•è³‡è¦åŠƒï¼Œéƒ½èƒ½å³æ™‚æŒæ¡è³‡ç”¢ç¾æ³ã€‚
                    </p>
                    <ul class="space-y-2 text-sm text-slate-500">
                        <li class="flex items-center"><span class="text-purple-500 mr-2">âœ“</span> ç›£æ§æˆ¿åœ°ç”¢å¸‚å ´è¶¨å‹¢</li>
                        <li class="flex items-center"><span class="text-purple-500 mr-2">âœ“</span> æ´»åŒ–è³‡ç”¢é…ç½®æ±ºç­–</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

{# === æ–°å¢å€å¡Š 4ï¼šç°¡æ˜“æµç¨‹ (CTA) === #}
<section class="py-20 bg-blue-600 text-white relative overflow-hidden">
    {# èƒŒæ™¯è£é£¾åœ“å½¢ #}
    <div class="absolute top-0 left-0 -ml-20 -mt-20 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 right-0 -mr-20 -mb-20 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>

    <div class="container mx-auto px-4 max-w-4xl text-center relative z-10">
        <h2 class="text-3xl font-bold mb-6">åªéœ€ä¸‰æ­¥é©Ÿï¼Œç«‹å³ç²å–ä¼°åƒ¹å ±å‘Š</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10 text-blue-100">
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-xl font-bold mb-3 border border-white/30">1</div>
                <p>è¼¸å…¥æˆ¿å±‹è©³ç´°è³‡è¨Š</p>
            </div>
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-xl font-bold mb-3 border border-white/30">2</div>
                <p>AI ç³»çµ±å³æ™‚é‹ç®—</p>
            </div>
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-xl font-bold mb-3 border border-white/30">3</div>
                <p>æŸ¥çœ‹å®Œæ•´ä¼°åƒ¹åˆ†æ</p>
            </div>
        </div>

        <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"
                class="inline-block px-10 py-3 bg-white text-blue-600 font-bold rounded-full shadow-lg hover:bg-gray-100 hover:scale-105 transition transform">
            é¦¬ä¸Šè©¦è©¦çœ‹
        </button>
    </div>
</section>

<!-- {# Loading Modal (ä¿æŒä¸è®Š) #}
<div id="valuation-loading-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl p-6 max-w-xs w-full mx-4 text-center transform scale-100 transition-all border border-white/20">
        <div class="relative flex justify-center mb-4">
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin"></div>
            </div>
            <div class="w-16 h-16 flex items-center justify-center rounded-full bg-blue-50">
                <span class="text-2xl animate-pulse">ğŸ </span>
            </div>
        </div>
        <h3 class="text-xl font-bold text-slate-800 mb-2">æ­£åœ¨ç‚ºæ‚¨ä¼°åƒ¹ä¸­...</h3>
        <div class="space-y-1 text-slate-500 text-sm">
            <p>AI æ­£åœ¨åˆ†æå‘¨é‚Šå¯¦åƒ¹ç™»éŒ„æ•¸æ“š</p>
            <p class="text-xs text-slate-400">è«‹ç¨å€™ï¼Œç³»çµ±å°‡è‡ªå‹•è·³è½‰è‡³çµæœé </p>
        </div>
    </div>
</div> -->

{# === [æ–°å¢] å³ä¸‹è§’æ‡¸æµ®é€²åº¦å¡ç‰‡ (å–ä»£èˆŠçš„æ»¿ç‰ˆ Modal) === #}
<div id="floating-status-card" class="hidden fixed bottom-6 right-6 z-[60] w-80 bg-white rounded-xl shadow-2xl border border-blue-100 overflow-hidden transform transition-all duration-300 translate-y-20 opacity-0">
    <div id="status-processing" class="p-4 flex items-center gap-4">
        <div class="relative w-12 h-12 flex-shrink-0">
            <div class="absolute inset-0 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-lg">ğŸ </span>
            </div>
        </div>
        <div>
            <h4 class="font-bold text-slate-800 text-sm">AI æ™ºèƒ½ä¼°åƒ¹ä¸­...</h4>
            <p class="text-xs text-slate-500 mt-0.5">æ­£åœ¨åˆ†æå‘¨é‚Šå¯¦åƒ¹ç™»éŒ„</p>
        </div>
    </div>

    <div id="status-completed" class="hidden">
        <div class="bg-green-50 p-4 flex items-center gap-4 cursor-pointer hover:bg-green-100 transition" onclick="goToResult()">
            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white flex-shrink-0 shadow-lg shadow-green-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <div class="flex-1">
                <h4 class="font-bold text-green-800 text-sm">ä¼°åƒ¹å®Œæˆï¼</h4>
                <p class="text-xs text-green-600 mt-0.5">é»æ“Šç«‹å³æŸ¥çœ‹å ±å‘Š â”</p>
            </div>
        </div>
    </div>
</div>

{# === [æ–°å¢] éŒ¯èª¤æç¤º Modal (é…åˆä½ çš„ Tailwind é¢¨æ ¼) === #}
<div id="error-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center">
    {# èƒŒæ™¯é®ç½©ï¼šé»æ“ŠèƒŒæ™¯ä¹Ÿå¯é—œé–‰ #}
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeErrorModal()"></div>
    
    {# å½ˆçª—æœ¬é«” #}
    <div class="relative bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 text-center transform scale-100 transition-all border border-red-100 animate-bounce-in">
        
        {# ç´…è‰²éŒ¯èª¤åœ–ç¤º #}
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-50 mb-4 border border-red-100">
            <svg class="h-8 w-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
        </div>

        <h3 class="text-xl font-bold text-slate-800 mb-2">ç„¡æ³•è­˜åˆ¥æ­¤åœ°å€</h3>
        
        {# é¡¯ç¤ºå¾Œç«¯å‚³ä¾†çš„éŒ¯èª¤è¨Šæ¯ #}
        <div class="text-slate-600 text-sm mb-6 leading-relaxed bg-red-50 p-3 rounded-lg border border-red-100">
            {% if form.non_field_errors %}
                {% for error in form.non_field_errors %}
                    <p class="font-medium text-red-700">{{ error }}</p>
                {% endfor %}
            {% else %}
                <p>è¼¸å…¥çš„åœ°å€å¯èƒ½æœ‰èª¤ï¼Œç³»çµ±ç„¡æ³•ç²¾ç¢ºå®šä½ã€‚<br>è«‹æª¢æŸ¥é–€ç‰Œè™Ÿç¢¼æ˜¯å¦æ­£ç¢ºã€‚</p>
            {% endif %}
        </div>

        <button onclick="closeErrorModal()" 
                class="w-full py-3 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg shadow-red-200 transition transform hover:-translate-y-0.5 focus:outline-none">
            å¥½çš„ï¼Œæˆ‘é‡æ–°å¡«å¯«
        </button>
    </div>
</div>

{# === [æ–°å¢] è‡ªå‹•é–‹å•Ÿ Modal çš„ Script === #}
<script>
    // å®šç¾©é—œé–‰å‡½å¼
    function closeErrorModal() {
        const modal = document.getElementById('error-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤ï¼Œè‹¥æœ‰å‰‡è‡ªå‹•é–‹å•Ÿ
    document.addEventListener('DOMContentLoaded', function() {
        // Django Template åˆ¤æ–·æ˜¯å¦æœ‰ non_field_errors
        {% if form.non_field_errors %}
            const errorModal = document.getElementById('error-modal');
            if (errorModal) {
                errorModal.classList.remove('hidden');
            }
        {% endif %}
    });
</script>

{% endblock content %}

{% block extra_js %}
<div id="ajax-url-container" data-towns-url="{% url 'core:get_towns_ajax' %}" style="display: none;"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="{% static 'core/js/estimation_handler.js' %}"></script>

{% endblock %}