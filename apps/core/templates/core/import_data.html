{% extends 'core/base_admin.html' %}
{% load static %}

{% block title %}批次資料匯入 - SmartVal{% endblock %}

{% block extra_css %}
{# 從原本 dashboard 搬過來的 Dropzone 樣式 #}
<style>
  .dropzone {
    border: 2px dashed #cbd5e1;
    border-radius: 0.75rem;
    background-color: #f8fafc;
    transition: all 0.2s ease-in-out;
    position: relative;
    overflow: hidden;
  }
  .dropzone:hover, .dropzone.drag-over {
    border-color: #3b82f6;
    background-color: #eff6ff;
    transform: scale(1.005);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  .dropzone-icon-wrapper {
    background-color: #e2e8f0;
    border-radius: 9999px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }
  .dropzone:hover .dropzone-icon-wrapper,
  .dropzone.drag-over .dropzone-icon-wrapper {
    background-color: #dbeafe;
    color: #2563eb;
  }
  .dropzone-icon svg {
    width: 40px;
    height: 40px;
    color: #64748b;
    transition: color 0.3s ease;
  }
  .dropzone:hover .dropzone-icon svg,
  .dropzone.drag-over .dropzone-icon svg {
    color: #2563eb;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out forwards;
  }
</style>
{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-slate-900">批次資料匯入</h1>
    <p class="text-slate-500 mt-1">透過 Excel 檔案大量更新系統資料。</p>
</div>

{# --- 匯入區塊 (內容完全從 Dashboard 搬移) --- #}
<div class="bg-white rounded-xl shadow-md border border-slate-100">
    <div class="p-8 border-b border-slate-100">
      <div class="flex items-center gap-3 mb-2">
          <div class="p-2 bg-indigo-100 rounded-lg text-indigo-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
          </div>
          <h2 class="text-2xl font-bold text-slate-900">上傳檔案</h2>
      </div>
      
      <div class="ml-11">
          <p class="text-slate-600 leading-relaxed">
              支援透過標準化 Excel 報表進行系統資料的批次更新與初始化。此功能可同時處理「房屋物件」、「仲介人員」及「成交客戶」等多維度數據。
          </p>
          
          <div class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 text-sm">
              <div class="flex justify-between items-center mb-2">
                  <h4 class="font-semibold text-slate-700 flex items-center gap-2">
                      <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                      匯入規範說明：
                  </h4>
                  <button type="button" onclick="openFormatModal()" class="text-blue-600 hover:text-blue-800 hover:underline font-medium flex items-center gap-1 transition-colors">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                      查看 Excel 格式範例
                  </button>
              </div>
              <ul class="list-disc list-inside text-slate-500 space-y-1 ml-1">
                  <li>檔案格式僅限 <span class="font-mono text-slate-700 bg-slate-200 px-1 rounded">.xlsx</span>。</li>
                  <li>活頁簿需包含以下工作表：<span class="font-medium text-slate-800">"房屋"</span>、<span class="font-medium text-slate-800">"仲介"</span>、<span class="font-medium text-slate-800">"買家"</span>。</li>
              </ul>
          </div>
      </div>
    </div>

    <div class="p-8">
      {# Form 區塊 #}
      <form id="upload-excel-form" action="{% url 'house:upload_excel' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div id="dropzone" class="dropzone flex flex-col items-center justify-center py-16 px-4 text-center cursor-pointer group">
            <div class="dropzone-icon-wrapper">
                <div class="dropzone-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                    </svg>
                </div>
            </div>
            <div id="dropzone-text">
                <p class="text-lg font-semibold text-slate-700 mb-1 group-hover:text-blue-600 transition-colors">
                    點擊此處上傳檔案，或將檔案拖曳至此
                </p>
                <p class="text-slate-400 text-sm">支援最大 10MB 的 Excel 檔案</p>
            </div>
            <div id="dropzone-file-info" class="hidden flex flex-col items-center animate-fade-in">
                <div class="flex items-center gap-2 text-emerald-600 bg-emerald-50 px-4 py-2 rounded-full mb-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span id="dropzone-file-name" class="font-medium"></span>
                </div>
                <p class="text-xs text-slate-400">檔案已準備就緒，請點擊下方按鈕開始匯入</p>
            </div>
            <input type="file" id="file-input" name="file" class="hidden" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
        </div>
      </form>

      <div class="mt-8 flex items-center justify-end gap-3 border-t border-slate-100 pt-6">
          <button type="button" id="clear-btn" class="hidden px-5 py-2.5 text-sm font-medium text-slate-600 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 focus:ring-4 focus:ring-slate-100 transition shadow-sm">取消</button>
          <button type="button" id="upload-btn" class="w-full sm:w-auto px-6 py-2.5 text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm hover:shadow focus:ring-4 focus:ring-blue-200 transition disabled:opacity-50 disabled:cursor-not-allowed">
              <span class="flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                  開始匯入資料
              </span>
          </button>
      </div>
      
      <div id="upload-status" class="mt-4">
          <div id="status-success" class="hidden rounded-lg bg-emerald-50 p-4 border border-emerald-100">
             <div class="flex"><div class="ml-3"><h3 class="text-sm font-medium text-emerald-800">匯入作業已啟動</h3><p class="mt-1 text-sm text-emerald-700" id="success-message"></p></div></div>
          </div>
          <div id="status-error" class="hidden rounded-lg bg-rose-50 p-4 border border-rose-100">
             <div class="flex"><div class="ml-3"><h3 class="text-sm font-medium text-rose-800">匯入失敗</h3><p class="mt-1 text-sm text-rose-700" id="error-message"></p></div></div>
          </div>
          <div id="status-loading" class="hidden flex justify-center items-center gap-3 py-4 text-slate-600 bg-slate-50 rounded-lg border border-slate-100">
              <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
              <span class="font-medium">系統正在處理您的檔案，請稍候...</span>
          </div>
      </div>
    </div>
</div>

{# --- Modal 區塊 (內容完全從 Dashboard 搬移) --- #}
<div id="format-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-5xl opacity-0 scale-95" id="modal-panel">
                
                {# Modal 標題 #}
                <div class="bg-slate-50 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-slate-100">
                    <h3 class="text-lg font-bold leading-6 text-slate-900" id="modal-title">Excel 資料匯入格式範例</h3>
                    <button type="button" onclick="closeFormatModal()" class="text-slate-400 hover:text-slate-500 focus:outline-none"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>

                <div class="px-4 py-4 sm:p-6">
                    {# Modal Tabs #}
                    <div class="border-b border-slate-200 mb-4">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button onclick="switchTab('house')" id="tab-btn-house" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">房屋 Sheet</button>
                            <button onclick="switchTab('agent')" id="tab-btn-agent" class="border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">仲介 Sheet</button>
                            <button onclick="switchTab('buyer')" id="tab-btn-buyer" class="border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">買家 Sheet</button>
                        </nav>
                    </div>

                    {# 1. 房屋表格內容 #}
                    <div id="tab-content-house" class="block animate-fade-in">
                        <p class="text-sm text-slate-500 mb-2">請確保 Excel 工作表名稱為 <span class="font-bold text-slate-800">"房屋"</span>，且包含以下欄位：</p>
                        <div class="overflow-x-auto border border-slate-200 rounded-lg">
                            <table class="min-w-full divide-y divide-slate-200 text-sm text-left">
                                <thead class="bg-slate-50 font-semibold text-slate-700 whitespace-nowrap">
                                    <tr>
                                        <th class="px-3 py-2">縣市</th>
                                        <th class="px-3 py-2">行政區</th>
                                        <th class="px-3 py-2">房屋類型</th>
                                        <th class="px-3 py-2">地址</th>
                                        <th class="px-3 py-2">所在層數</th>
                                        <th class="px-3 py-2">地坪</th>
                                        <th class="px-3 py-2">地上總層數</th>
                                        <th class="px-3 py-2">建坪</th>
                                        <th class="px-3 py-2">房間數</th>
                                        <th class="px-3 py-2">總價格(萬元)</th>
                                        <th class="px-3 py-2">建坪單價(萬元/坪)</th>
                                        <th class="px-3 py-2">經度</th>
                                        <th class="px-3 py-2">緯度</th>
                                        <th class="px-3 py-2">屋齡(年)</th>
                                        <th class="px-3 py-2">出售日期</th>
                                        <th class="px-3 py-2">仲介</th>
                                        <th class="px-3 py-2">買家</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200 bg-white whitespace-nowrap text-slate-600">
                                    <tr>
                                        <td class="px-3 py-2">新北市</td>
                                        <td class="px-3 py-2">三峽區</td>
                                        <td class="px-3 py-2">大樓</td>
                                        <td class="px-3 py-2">大學路123號</td>
                                        <td class="px-3 py-2">10</td>
                                        <td class="px-3 py-2">5.5</td>
                                        <td class="px-3 py-2">15</td>
                                        <td class="px-3 py-2">40.2</td>
                                        <td class="px-3 py-2">3</td>
                                        <td class="px-3 py-2">1580</td>
                                        <td class="px-3 py-2">39.3</td>
                                        <td class="px-3 py-2">121.36</td>
                                        <td class="px-3 py-2">24.93</td>
                                        <td class="px-3 py-2">5.2</td>
                                        <td class="px-3 py-2">2024-10-01</td>
                                        <td class="px-3 py-2">王小明</td>
                                        <td class="px-3 py-2">陳大文</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {# 2. 仲介表格內容 #}
                    <div id="tab-content-agent" class="hidden animate-fade-in">
                        <p class="text-sm text-slate-500 mb-2">請確保 Excel 工作表名稱為 <span class="font-bold text-slate-800">"仲介"</span>，且包含以下欄位：</p>
                        <div class="overflow-x-auto border border-slate-200 rounded-lg">
                            <table class="min-w-full divide-y divide-slate-200 text-sm text-left">
                                <thead class="bg-slate-50 font-semibold text-slate-700 whitespace-nowrap">
                                    <tr>
                                        <th class="px-4 py-2">姓名</th>
                                        <th class="px-4 py-2">聯絡電話</th>
                                        <th class="px-4 py-2">電子郵件</th>
                                        <th class="px-4 py-2">隸屬公司</th>
                                        <th class="px-4 py-2">分行名稱</th>
                                        <th class="px-4 py-2">分行縣市</th>
                                        <th class="px-4 py-2">分行行政區</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200 bg-white text-slate-600">
                                    <tr>
                                        <td class="px-4 py-2">王小明</td>
                                        <td class="px-4 py-2">0912-345-678</td>
                                        <td class="px-4 py-2">wang@example.com</td>
                                        <td class="px-4 py-2">信義房屋</td>
                                        <td class="px-4 py-2">三峽北大店</td>
                                        <td class="px-4 py-2">新北市</td>
                                        <td class="px-4 py-2">三峽區</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {# 3. 買家表格內容 #}
                    <div id="tab-content-buyer" class="hidden animate-fade-in">
                        <p class="text-sm text-slate-500 mb-2">請確保 Excel 工作表名稱為 <span class="font-bold text-slate-800">"買家"</span>，且包含以下欄位：</p>
                        <div class="overflow-x-auto border border-slate-200 rounded-lg">
                            <table class="min-w-full divide-y divide-slate-200 text-sm text-left">
                                <thead class="bg-slate-50 font-semibold text-slate-700 whitespace-nowrap">
                                    <tr>
                                        <th class="px-4 py-2">姓名</th>
                                        <th class="px-4 py-2">聯絡電話</th>
                                        <th class="px-4 py-2">電子郵件</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200 bg-white text-slate-600">
                                    <tr>
                                        <td class="px-4 py-2">陳大文</td>
                                        <td class="px-4 py-2">0988-765-432</td>
                                        <td class="px-4 py-2">chen@example.com</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-slate-100">
                    <button type="button" onclick="closeFormatModal()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto">關閉</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// --- Modal 控制邏輯 (完全沿用) ---
function openFormatModal() {
    const modal = document.getElementById('format-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const panel = document.getElementById('modal-panel');
    modal.classList.remove('hidden');
    setTimeout(() => {
        backdrop.classList.remove('opacity-0');
        panel.classList.remove('opacity-0', 'scale-95');
        panel.classList.add('opacity-100', 'scale-100');
    }, 10);
}
function closeFormatModal() {
    const modal = document.getElementById('format-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const panel = document.getElementById('modal-panel');
    backdrop.classList.remove('opacity-100');
    panel.classList.remove('opacity-100', 'scale-100');
    panel.classList.add('opacity-0', 'scale-95');
    setTimeout(() => { modal.classList.add('hidden'); }, 300);
}
function switchTab(tabName) {
    ['house', 'agent', 'buyer'].forEach(t => {
        document.getElementById(`tab-content-${t}`).classList.add('hidden');
        const btn = document.getElementById(`tab-btn-${t}`);
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');
    });
    document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
    const activeBtn = document.getElementById(`tab-btn-${tabName}`);
    activeBtn.classList.remove('border-transparent', 'text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');
    activeBtn.classList.add('border-blue-500', 'text-blue-600');
}
document.addEventListener('click', function(event) {
    const modal = document.getElementById('format-modal');
    if (!modal.classList.contains('hidden') && event.target.id === "modal-backdrop") closeFormatModal();
});
document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") closeFormatModal();
});

// --- Dropzone 與 上傳邏輯 (完全沿用，包含 sessionStorage/Toast) ---
document.addEventListener('DOMContentLoaded', function() {
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('file-input');
  const uploadForm = document.getElementById('upload-excel-form');
  const uploadBtn = document.getElementById('upload-btn');
  const clearBtn = document.getElementById('clear-btn');
  const dropzoneText = document.getElementById('dropzone-text');
  const fileNameElement = document.getElementById('dropzone-file-name');
  const dropzoneFileInfo = document.getElementById('dropzone-file-info');
  
  const statusLoading = document.getElementById('status-loading');
  const statusSuccess = document.getElementById('status-success');
  const statusError = document.getElementById('status-error');
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');

  let uploadedFile = null;

  function showStatus(type, message) {
    statusLoading.classList.add('hidden');
    statusSuccess.classList.add('hidden');
    statusError.classList.add('hidden');
    if (type === 'loading') {
      statusLoading.classList.remove('hidden');
    } else if (type === 'success') {
      successMessage.textContent = message;
      statusSuccess.classList.remove('hidden');
    } else if (type === 'error') {
      errorMessage.textContent = message;
      statusError.classList.remove('hidden');
    }
  }
  
  function setFile(file) {
    if (file && (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || file.name.endsWith('.xlsx'))) {
        uploadedFile = file;
        dropzoneText.classList.add('hidden');
        dropzoneFileInfo.classList.remove('hidden');
        fileNameElement.textContent = file.name;
        clearBtn.classList.remove('hidden');
        uploadBtn.disabled = false;
        dropzone.classList.add('border-emerald-500', 'bg-emerald-50/30');
        dropzone.querySelector('.dropzone-icon svg').style.color = '#10b981';
        showStatus(null); 
    } else {
        showStatus('error', '檔案格式錯誤，系統僅支援標準 .xlsx 格式。');
        clearFile();
    }
  }

  function clearFile() {
    uploadedFile = null;
    fileInput.value = null;
    dropzoneText.classList.remove('hidden');
    dropzoneFileInfo.classList.add('hidden');
    fileNameElement.textContent = '';
    clearBtn.classList.add('hidden');
    uploadBtn.disabled = true;
    dropzone.classList.remove('border-emerald-500', 'bg-emerald-50/30');
    dropzone.querySelector('.dropzone-icon svg').style.color = ''; 
  }
  
  clearFile();

  dropzone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) setFile(e.target.files[0]); });
  clearBtn.addEventListener('click', clearFile);
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropzone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false));
  ['dragenter', 'dragover'].forEach(eventName => dropzone.addEventListener(eventName, () => dropzone.classList.add('drag-over'), false));
  ['dragleave', 'drop'].forEach(eventName => dropzone.addEventListener(eventName, () => dropzone.classList.remove('drag-over'), false));
  dropzone.addEventListener('drop', (e) => { if (e.dataTransfer.files.length > 0) setFile(e.dataTransfer.files[0]); }, false);

  uploadBtn.addEventListener('click', () => {
    if (!uploadedFile) return;
    sessionStorage.setItem('is_excel_processing', 'true');
    if (window.showToast) window.showToast('processing', '檔案已上傳，系統正在背景處理中...');
    uploadBtn.disabled = true;
    clearBtn.disabled = true;
    showStatus('loading'); 

    const formData = new FormData();
    formData.append('file', uploadedFile);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(uploadForm.action, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
         clearFile();
         showStatus('success', '檔案已上傳，系統正在背景處理中...');
      } else {
        showStatus('error', data.error || '上傳失敗');
        if (window.showToast) window.showToast('error', data.error);
      }
      uploadBtn.disabled = false; clearBtn.disabled = false;
    })
    .catch(error => {
      console.error(error);
      showStatus('error', '上傳連線失敗');
      if (window.showToast) window.showToast('error', '連線失敗');
      uploadBtn.disabled = false; clearBtn.disabled = false;
    });
  });
});
</script>
{% endblock %}