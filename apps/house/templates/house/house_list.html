<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>房屋列表 - {{ total_count }} 筆資料</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">

  <header class="sticky top-0 z-10 border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-5 flex items-center justify-between">
      <h1 class="text-2xl font-semibold tracking-tight">房屋列表</h1>
      <span class="text-sm text-slate-500">共 {{ total_count }} 筆資料</span>
      
      <button type="button" id="open-create-modal-btn" class="px-4 py-2 text-sm font-semibold text-white bg-green-600 hover:bg-green-700 rounded-lg">
        新增房屋
      </button>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8">
    {% if houses %}
      
      <div class="bg-white shadow-md rounded-lg overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
          
          <thead class="bg-slate-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                房屋地址
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                房屋類型
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                總價
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                房屋中介
              </th>
              <th scope="col" class="relative px-6 py-3">
                <span class="sr-only">操作</span>
              </th>
            </tr>
          </thead>

          <tbody id="house-table-body" class="bg-white divide-y divide-slate-200">
            {% for house in houses %}
              
              {% include 'house/_house_table_row.html' with house=house %}

            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="rounded-2xl border border-dashed border-slate-300 bg-white p-12 text-center">
        <p class="text-slate-500">目前沒有房屋資料。</p>
      </div>
    {% endif %}
  </main>

  <footer class="mx-auto max-w-6xl px-4 py-8 text-center text-xs text-slate-400">
    Powered by Django · Tailwind
  </footer>

  <div id="create-house-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all">
        
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 flex items-center justify-between rounded-t-2xl sticky top-0 z-10">
            <h2 class="text-2xl font-bold text-white flex items-center">
                新增房屋
            </h2>
            <button id="close-modal-btn-x" class="text-white hover:text-gray-200 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <form id="create-house-form" method="post" action="{% url 'house:house_create' %}" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div id="modal-form-errors" class="hidden rounded-md bg-red-50 p-4 m-6">
              <h3 class="text-sm font-medium text-red-800">儲存失敗</h3>
              <div class="mt-2 text-sm text-red-700">
                <ul id="modal-error-list" class="list-disc space-y-1 pl-5">
                  </ul>
              </div>
            </div>

            <div class="p-6 space-y-5">
              
              {% include 'house/_house_form_fields.html' %}
              
            </div>
          
            <div class="flex items-center gap-x-4 bg-gray-50 px-6 py-4 rounded-b-2xl sticky bottom-0 z-10 border-t">
              <button type="submit" id="modal-submit-btn"
                class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
                儲存
              </button>
              <button type="button" id="close-modal-btn-cancel"
                class="inline-flex items-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-400">
                取消
              </button>
            </div>
        </form>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      
      // --- Modal 元素 ---
      const modal = document.getElementById('create-house-modal');
      const openBtn = document.getElementById('open-create-modal-btn');
      // 【修正】關閉按鈕現在有 2 個
      const closeButtons = [
        document.getElementById('close-modal-btn-x'),
        document.getElementById('close-modal-btn-cancel')
      ];
      
      // --- AJAX 表單元素 ---
      const createForm = document.getElementById('create-house-form');
      const submitBtn = document.getElementById('modal-submit-btn');
      const errorContainer = document.getElementById('modal-form-errors');
      const errorList = document.getElementById('modal-error-list');
      const tableBody = document.getElementById('house-table-body');
      
      // --- Modal 顯示/隱藏 ---
      const showModal = () => modal.classList.remove('hidden');
      const hideModal = () => {
        modal.classList.add('hidden');
        createForm.reset(); // 關閉時重置表單
        clearErrors(); // 關閉時清除錯誤
      };

      openBtn.addEventListener('click', showModal);
      closeButtons.forEach(btn => btn.addEventListener('click', hideModal));
      
      // --- AJAX 表單提交 ---
      createForm.addEventListener('submit', function (e) {
        e.preventDefault(); // 阻止表單傳統提交
        clearErrors();
        submitBtn.disabled = true;
        submitBtn.textContent = '儲存中...';

        const formData = new FormData(createForm);
        const actionUrl = createForm.action;
        
        fetch(actionUrl, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            'X-Requested-With': 'XMLHttpRequest' // 讓 Django 知道這是 AJAX
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 【成功】
            // 1. 將新 <tr> HTML 加到表格頂部
            tableBody.insertAdjacentHTML('afterbegin', data.house_html);
            // 2. 關閉 Modal
            hideModal();
          } else {
            // 【失敗】
            showErrors(data.errors);
          }
        })
        .catch(error => {
          console.error('AJAX 提交失敗:', error);
          showErrors({ 'general': ['發生未預期的錯誤，請稍後再試。'] });
        })
        .finally(() => {
          // 恢復按鈕
          submitBtn.disabled = false;
          submitBtn.textContent = '儲存';
        });
      });

      // --- 錯誤處理 ---
      function showErrors(errors) {
        errorList.innerHTML = ''; // 清空舊錯誤
        
        // 將 Django 回傳的 errors 物件 (e.g., {'address': ['...'], 'house_age': [...]})
        // 轉化為 <li> 列表
        for (const field in errors) {
          errors[field].forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            errorList.appendChild(li);
          });
        }
        errorContainer.classList.remove('hidden');
      }

      function clearErrors() {
        errorContainer.classList.add('hidden');
        errorList.innerHTML = '';
      }

      // 
      // --- 【重要】Modal 內的 JS (連動選單 + 日期選擇器) ---
      // 

      // --- 1. 連動選單 (必須指定 Modal 內的 ID) ---
      const modalCitySelect = document.querySelector('#create-house-form #id_city');
      const modalTownSelect = document.querySelector('#create-house-form #id_town');
      const ajaxUrl = "{% url 'house:ajax_load_towns' %}";

      modalCitySelect.addEventListener('change', function () {
        const selectedCity = this.value;
        modalTownSelect.innerHTML = ''; // 清空

        if (!selectedCity) {
          modalTownSelect.add(new Option('請先選擇縣市', ''));
          return;
        }

        modalTownSelect.add(new Option('載入中...', ''));

        fetch(`${ajaxUrl}?city=${selectedCity}`)
          .then(response => response.json())
          .then(data => {
            modalTownSelect.innerHTML = ''; // 移除「載入中」
            modalTownSelect.add(new Option('請選擇房屋所在行政區', '')); 
            data.towns.forEach(function (town) {
              modalTownSelect.add(new Option(town, town));
            });
          })
          .catch(error => {
            console.error('Error loading towns:', error);
            modalTownSelect.innerHTML = '';
            modalTownSelect.add(new Option('載入失敗', ''));
          });
      });

      // --- 2. 日期選擇器 (必須指定 Modal 內的 ID) ---
      if (document.querySelector('#create-house-form #id_sold_time')) {
        flatpickr('#create-house-form #id_sold_time', {
          dateFormat: 'Y-m-d',
          allowInput: true,
          locale: 'zh_tw'
        });
      }

    });
  </script>

</body>
</html>